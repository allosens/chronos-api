generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id                     String                  @id @default(uuid())
  name                   String                  @db.VarChar(255)
  email                  String                  @unique @db.VarChar(255)
  phone                  String?                 @db.VarChar(50)
  address                String?
  subscriptionPlan       SubscriptionPlan        @default(FREE)
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  deletedAt              DateTime?
  absenceRequests        AbsenceRequest[]
  auditLogs              AuditLog[]
  companySettings        CompanySetting[]
  employees              Employee[]
  invoices               Invoice[]
  timeCorrectionRequests TimeCorrectionRequest[]
  users                  User[]
  workSessions           WorkSession[]

  @@map("companies")
}

model User {
  id                            String                  @id @default(uuid())
  companyId                     String?
  email                         String                  @unique @db.VarChar(255)
  passwordHash                  String                  @db.VarChar(255)
  firstName                     String                  @db.VarChar(100)
  lastName                      String                  @db.VarChar(100)
  role                          UserRole                @default(EMPLOYEE)
  isActive                      Boolean                 @default(true)
  emailVerifiedAt               DateTime?
  lastLoginAt                   DateTime?
  createdAt                     DateTime                @default(now())
  updatedAt                     DateTime                @updatedAt
  deletedAt                     DateTime?
  reviewedAbsenceRequests       AbsenceRequest[]        @relation("AbsenceRequestReviewedBy")
  absenceRequests               AbsenceRequest[]
  auditLogs                     AuditLog[]
  deactivatedEmployees          Employee[]              @relation("EmployeeDeactivatedBy")
  employee                      Employee?
  passwordResetTokens           PasswordResetToken[]
  createdTimeCorrectionRequests TimeCorrectionRequest[] @relation("TimeCorrectionReviewedBy")
  timeCorrectionRequests        TimeCorrectionRequest[]
  company                       Company?                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  workSessions                  WorkSession[]

  @@map("users")
}

model Employee {
  id                  String         @id @default(uuid())
  userId              String         @unique
  companyId           String
  employeeNumber      String?        @db.VarChar(50)
  position            String?        @db.VarChar(100)
  department          String?        @db.VarChar(100)
  phoneNumber         String?        @db.VarChar(50)
  hireDate            DateTime?      @db.Date
  status              EmployeeStatus @default(ACTIVE)
  vacationDaysPerYear Int            @default(22)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  deactivatedAt       DateTime?
  deactivatedBy       String?
  company             Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deactivatedByUser   User?          @relation("EmployeeDeactivatedBy", fields: [deactivatedBy], references: [id])
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("employees")
}

model CompanySetting {
  id           String   @id @default(uuid())
  companyId    String
  settingKey   String   @db.VarChar(100)
  settingValue Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, settingKey])
  @@map("company_settings")
}

model WorkSession {
  id                     String                  @id @default(uuid())
  userId                 String
  companyId              String
  date                   DateTime                @db.Date
  clockIn                DateTime
  clockOut               DateTime?
  status                 WorkStatus              @default(WORKING)
  totalHours             Decimal?                @db.Decimal(5, 2)
  notes                  String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  breaks                 Break[]
  timeCorrectionRequests TimeCorrectionRequest[]
  company                Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("work_sessions")
}

model Break {
  id              String      @id @default(uuid())
  workSessionId   String
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?
  createdAt       DateTime    @default(now())
  workSession     WorkSession @relation(fields: [workSessionId], references: [id], onDelete: Cascade)

  @@map("breaks")
}

model AbsenceRequest {
  id             String        @id @default(uuid())
  userId         String
  companyId      String
  type           AbsenceType
  startDate      DateTime      @db.Date
  endDate        DateTime      @db.Date
  totalDays      Int
  year           Int
  comments       String?
  status         RequestStatus @default(PENDING)
  requestedAt    DateTime      @default(now())
  reviewedAt     DateTime?
  reviewedBy     String?
  reviewComments String?
  company        Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reviewer       User?         @relation("AbsenceRequestReviewedBy", fields: [reviewedBy], references: [id])
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("absence_requests")
}

model TimeCorrectionRequest {
  id                String        @id @default(uuid())
  userId            String
  companyId         String
  workSessionId     String
  originalClockIn   DateTime?
  originalClockOut  DateTime?
  requestedClockIn  DateTime?
  requestedClockOut DateTime?
  reason            String
  status            RequestStatus @default(PENDING)
  createdAt         DateTime      @default(now())
  reviewedAt        DateTime?
  reviewedBy        String?
  reviewNotes       String?
  company           Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reviewer          User?         @relation("TimeCorrectionReviewedBy", fields: [reviewedBy], references: [id])
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workSession       WorkSession   @relation(fields: [workSessionId], references: [id], onDelete: Cascade)

  @@map("time_correction_requests")
}

model Invoice {
  id            String        @id @default(uuid())
  companyId     String
  invoiceNumber String        @unique @db.VarChar(50)
  invoiceDate   DateTime      @db.Date
  dueDate       DateTime      @db.Date
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("EUR") @db.VarChar(3)
  status        InvoiceStatus @default(DRAFT)
  notes         String?
  createdAt     DateTime      @default(now())
  paidAt        DateTime?
  items         InvoiceItem[]
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String   @db.VarChar(255)
  quantity    Decimal  @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String?
  companyId  String?
  entityType String      @db.VarChar(50)
  entityId   String
  action     AuditAction
  oldValues  Json?
  newValues  Json?
  ipAddress  String?     @db.Inet
  userAgent  String?
  createdAt  DateTime    @default(now())
  company    Company?    @relation(fields: [companyId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

enum UserRole {
  SUPER_ADMIN
  COMPANY_ADMIN
  EMPLOYEE
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum WorkStatus {
  CLOCKED_OUT
  WORKING
  ON_BREAK
}

enum TimesheetStatus {
  COMPLETE
  INCOMPLETE
  IN_PROGRESS
  ERROR
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum AbsenceType {
  VACATION
  PERSONAL_DAY
  SICK_LEAVE
  COMPENSATORY_TIME
  OTHER
}

enum SubscriptionPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  LOGIN
  LOGOUT
  ROLE_CHANGED
  PERMISSION_GRANTED
  PERMISSION_REVOKED
}
