// Chronos Time Tracking API - Prisma Schema
// Multi-tenant SaaS architecture with company isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// CORE ENTITIES - Multi-tenant Architecture
// ============================================================================

model Company {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  email     String?
  timezone  String   @default("UTC")
  settings  Json?    @default("{}")
  
  // Subscription & Billing
  plan      String   @default("free") // free, basic, premium
  maxUsers  Int      @default(10)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  users        User[]
  projects     Project[]
  timeEntries  TimeEntry[]
  reports      Report[]
  invitations  Invitation[]
  
  @@map("companies")
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  firstName   String
  lastName    String
  avatar      String?
  
  // Authentication
  password    String
  emailVerified DateTime?
  isActive    Boolean   @default(true)
  
  // Multi-tenant
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Role & Permissions
  role        UserRole  @default(EMPLOYEE)
  permissions Json?     @default("[]")
  
  // Work Info
  hourlyRate  Decimal?  @db.Decimal(10, 2)
  startDate   DateTime?
  endDate     DateTime?
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?
  
  // Relations
  timeEntries    TimeEntry[]
  projectMembers ProjectMember[]
  reports        Report[]
  createdReports Report[]      @relation("ReportCreatedBy")
  
  @@map("users")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?  @default("#3B82F6")
  
  // Multi-tenant
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Project Settings
  isActive    Boolean  @default(true)
  isPublic    Boolean  @default(false)
  hourlyRate  Decimal? @db.Decimal(10, 2)
  budget      Decimal? @db.Decimal(12, 2)
  
  // Client Info
  clientName  String?
  clientEmail String?
  
  // Timestamps
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members     ProjectMember[]
  timeEntries TimeEntry[]
  
  @@map("projects")
}

model ProjectMember {
  id        String      @id @default(cuid())
  
  // Relations
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Role in project
  role      ProjectRole @default(MEMBER)
  
  // Timestamps
  joinedAt  DateTime    @default(now())
  
  @@unique([userId, projectId])
  @@map("project_members")
}

model TimeEntry {
  id          String   @id @default(cuid())
  
  // Multi-tenant (required for all records)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Core fields
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // Time tracking
  description String?
  startTime   DateTime
  endTime     DateTime?
  duration    Int?     // Duration in minutes (calculated or manual)
  
  // Entry type and status
  isRunning   Boolean  @default(false)
  isBillable  Boolean  @default(true)
  hourlyRate  Decimal? @db.Decimal(10, 2)
  
  // Metadata
  tags        Json?    @default("[]")
  location    String?  // GPS or manual location
  
  // Timestamps
  date        DateTime @default(now()) @db.Date
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId, userId, date])
  @@index([companyId, projectId])
  @@index([isRunning])
  @@map("time_entries")
}

model Report {
  id          String     @id @default(cuid())
  name        String
  description String?
  
  // Multi-tenant
  companyId   String
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Report configuration
  type        ReportType @default(TIME_SUMMARY)
  filters     Json       @default("{}")
  data        Json?      // Cached report data
  
  // Access control
  isPublic    Boolean    @default(false)
  createdById String
  createdBy   User       @relation("ReportCreatedBy", fields: [createdById], references: [id])
  
  // Sharing
  sharedWith  User[]
  
  // Timestamps
  generatedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@map("reports")
}

model Invitation {
  id        String           @id @default(cuid())
  email     String
  
  // Multi-tenant
  companyId String
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Invitation details
  role      UserRole         @default(EMPLOYEE)
  status    InvitationStatus @default(PENDING)
  token     String           @unique
  
  // Timestamps
  expiresAt DateTime
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  
  @@unique([email, companyId])
  @@map("invitations")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum ProjectRole {
  ADMIN
  MEMBER
}

enum ReportType {
  TIME_SUMMARY
  PROJECT_SUMMARY
  USER_SUMMARY
  DETAILED
  INVOICE
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}
